trigger:
  branches:
    include:
      - master

schedules:
  - cron: 0 0 * * Sun
    displayName: Weekly Rebuild
    branches:
      include: ["master"]
    always: true
    batch: true

pool:
  name: Pool-KF

variables:
  dockerfilePath: '.devcontainer/Dockerfile'
  imageRepository: 'cortisone/devcontainer'
  containerRegistry: 'acrukscortshrdcont01.azurecr.io'
  containerRegistryConnection: 'acrukscortshrdcont01'
  tag: '$(Build.BuildId)'
  majorVersion: '1'
  minorVersion: '0'
  patchVersion: '$(Build.BuildId)'
  semanticVersion: '$(majorVersion).$(minorVersion).$(patchVersion)'
  # Use --no-cache on scheduled builds to pick up upstream updates
  ${{ if eq(variables['Build.Reason'], 'Schedule') }}:
    buildArgs: '--no-cache'
  ${{ else }}:
    buildArgs: '--cache-from $(containerRegistry)/$(imageRepository):latest'

stages:
- stage: Validate
  displayName: 'Validate and Lint'
  jobs:
  - job: Lint
    displayName: 'Lint Scripts and Configs'
    steps:
    - checkout: self

    - task: Bash@3
      displayName: 'Syntax check shell scripts'
      inputs:
        targetType: 'inline'
        script: |
          echo "Checking shell scripts..."
          errors=0
          for script in .devcontainer/files/install/*.sh scripts/*.sh tests/*.sh; do
            if [ -f "$script" ]; then
              if ! bash -n "$script" 2>&1; then
                echo "FAIL: $script"
                errors=$((errors + 1))
              else
                echo "OK: $script"
              fi
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "$errors script(s) failed syntax check"
            exit 1
          fi
          echo "All shell scripts are valid"

    - task: Bash@3
      displayName: 'Validate JSON files'
      inputs:
        targetType: 'inline'
        script: |
          echo "Checking JSON files..."
          errors=0
          for json in $(find . -name "*.json" -not -path "*/.git/*"); do
            if ! python3 -m json.tool "$json" > /dev/null 2>&1; then
              echo "FAIL: $json"
              errors=$((errors + 1))
            else
              echo "OK: $json"
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "$errors JSON file(s) are invalid"
            exit 1
          fi
          echo "All JSON files are valid"

    - task: Bash@3
      displayName: 'Lint Dockerfile with Hadolint'
      inputs:
        targetType: 'inline'
        script: |
          echo "Linting Dockerfile..."
          docker run --rm -i hadolint/hadolint hadolint \
            --ignore DL3008 \
            --ignore DL3009 \
            --ignore DL3015 \
            - < $(dockerfilePath)

- stage: Build
  displayName: 'Build and Test'
  dependsOn: Validate
  jobs:
  - job: BuildImage
    displayName: 'Build Docker Image'
    timeoutInMinutes: 120
    steps:
    - checkout: self
      persistCredentials: true

    - task: Bash@3
      displayName: 'Clean docker cache'
      inputs:
        targetType: 'inline'
        script: |
          docker system prune -a -f

    - task: Docker@2
      displayName: 'Build image'
      inputs:
        containerRegistry: '$(containerRegistryConnection)'
        repository: '$(imageRepository)'
        command: 'build'
        Dockerfile: '$(dockerfilePath)'
        arguments: '$(buildArgs)'
        tags: |
          latest
          $(tag)
          $(semanticVersion)

    - task: Bash@3
      displayName: 'Test image - validate tools'
      inputs:
        targetType: 'inline'
        script: |
          echo "Running validation tests against built image..."
          docker run --rm --entrypoint "" $(containerRegistry)/$(imageRepository):$(tag) bash -c "
            set -e
            echo '=== Terraform ===' && terraform version
            echo '=== Terragrunt ===' && terragrunt --version
            echo '=== kubectl ===' && kubectl version --client
            echo '=== Helm ===' && helm version
            echo '=== Azure CLI ===' && az version
            echo '=== Ansible ===' && ansible --version
            echo '=== PowerShell ===' && pwsh --version
            echo '=== Python ===' && python3 --version
            echo '=== tflint ===' && tflint --version
            echo '=== checkov ===' && checkov --version
            echo '=== yq ===' && yq --version
            echo '=== jq ===' && jq --version
            echo '=== git-crypt ===' && git-crypt --version
            echo '=== pre-commit ===' && pre-commit --version
            echo 'All tools validated successfully'
          "

- stage: SecurityScan
  displayName: 'Security Scanning'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: ScanImage
    displayName: 'Vulnerability Scan'
    steps:
    - checkout: self

    - task: Bash@3
      displayName: 'Scan Dockerfile with Checkov'
      inputs:
        targetType: 'inline'
        script: |
          pip3 install --quiet checkov
          checkov -d .devcontainer --framework dockerfile --soft-fail

    - task: Bash@3
      displayName: 'Run Trivy scan'
      inputs:
        targetType: 'inline'
        script: |
          # Install Trivy if not present
          if ! command -v trivy &> /dev/null; then
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          fi
          # Scan image for HIGH and CRITICAL vulnerabilities
          trivy image --severity HIGH,CRITICAL --exit-code 0 $(containerRegistry)/$(imageRepository):$(tag)

- stage: Push
  displayName: 'Push to Registry'
  dependsOn: SecurityScan
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
  - job: PushImage
    displayName: 'Push to ACR'
    steps:
    - checkout: self

    - task: Docker@2
      displayName: 'Push image to ACR'
      timeoutInMinutes: 120
      inputs:
        containerRegistry: '$(containerRegistryConnection)'
        repository: '$(imageRepository)'
        command: 'push'
        tags: |
          latest
          $(tag)
          $(semanticVersion)

    - task: Bash@3
      displayName: 'Build summary'
      inputs:
        targetType: 'inline'
        script: |
          echo "================================"
          echo "DevContainer Build Complete"
          echo "================================"
          echo "Build ID: $(Build.BuildId)"
          echo "Version: $(semanticVersion)"
          echo "Branch: $(Build.SourceBranch)"
          echo "Tags pushed:"
          echo "  - $(containerRegistry)/$(imageRepository):latest"
          echo "  - $(containerRegistry)/$(imageRepository):$(tag)"
          echo "  - $(containerRegistry)/$(imageRepository):$(semanticVersion)"
          echo "================================"

    - task: Bash@3
      displayName: 'Clean docker cache'
      inputs:
        targetType: 'inline'
        script: |
          docker system prune -a -f
